<!-- app/views/shared/_javascript.html.erb -->

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<script>
  $(document).ready(function() {

    // Loading Placeholder (JS)
    $('#cover-letter-form').on('submit', function(e) {
      e.preventDefault();
      var form = $(this);
      var submitBtn = $('#submit-btn');
      var loadingPlaceholder = $('#loading-placeholder');
      var coverLetterContainer = $('#generated-cover-letter-container');
      var coverLetterContent = $('#generated-cover-letter');

      submitBtn.prop('disabled', true);
      loadingPlaceholder.removeClass('d-none');
      coverLetterContainer.addClass('d-none');

      $.ajax({
        url: form.attr('action'),
        method: form.attr('method'),
        data: form.serialize(),
        dataType: 'json',
        success: function(response) {
          loadingPlaceholder.addClass('d-none');
          coverLetterContent.html(response.cover_letter);
          coverLetterContainer.removeClass('d-none');
          submitBtn.prop('disabled', false);
        },
        error: function() {
          alert('An error occurred while generating the cover letter. Please try again.');
          loadingPlaceholder.addClass('d-none');
          submitBtn.prop('disabled', false);
        }
      });
    });

    // Handles clipboard copy function
    $('#copy-btn').on('click', function() {
      var coverLetterContent = $('#generated-cover-letter').text();
      var tempTextarea = $('<textarea>');
      $('body').append(tempTextarea);
      tempTextarea.val(coverLetterContent).select();
      document.execCommand('copy');
      tempTextarea.remove();
      alert('Cover letter copied to clipboard!');
    });

    // Load resume button click event
    $('#load-resume-btn').on('click', function() {
      console.log("Load Resume button clicked");
      $.ajax({
        url: '/user_resumes',
        method: 'get',
        dataType: 'json',
        success: function(response) {
          console.log("AJAX request successful", response);
          if (response.resumes && response.resumes.length > 0) {
            var resume = response.resumes[0];
            $('#resume-textarea').val(resume.resume);
          } else {
            alert('No resumes found.');
          }
        },
        error: function(xhr, status, error) {
          console.log("AJAX request failed", status, error);
          alert('An error occurred while loading the resume. Please try again.');
        }
      });
    });

    // Load job description button click event
    $('#load-job-description-btn').on('click', function() {
      console.log("Load Job Description button clicked");
      $.ajax({
        url: '/user_job_descriptions',
        method: 'get',
        dataType: 'json',
        success: function(response) {
          console.log("AJAX request successful", response);
          if (response.job_postings && response.job_postings.length > 0) {
            var jobDescriptionList = $('#job-description-list');
            jobDescriptionList.empty(); // Clear existing list items

            response.job_postings.forEach(function(job) {
              var listItem = $('<li class="list-group-item list-group-item-action">')
                .text(job.job_description)
                .data('description', job.job_description)
                .on('click', function() {
                  $('#job-description-textarea').val($(this).data('description'));
                  $('#jobDescriptionModal').modal('hide');
                });

              jobDescriptionList.append(listItem);
            });

            $('#jobDescriptionModal').modal('show');
          } else {
            alert('No job descriptions found.');
          }
        },
        error: function(xhr, status, error) {
          console.log("AJAX request failed", status, error);
          alert('An error occurred while loading the job descriptions. Please try again.');
        }
      });
    });
  });
</script>
